From ca7ee26a7e2cc70392731919818883d306dfa727 Mon Sep 17 00:00:00 2001
From: shellyxx <shellyx.xie@intel.com>
Date: Fri, 27 Dec 2019 12:13:41 +0800
Subject: [PATCH] Add package installer user isolation

Tracked-On:
Change-Id: I3394b8f927ec96bd05303e8bd0a7162c526058d8
---
 .../java/com/android/server/pm/Settings.java   | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/services/core/java/com/android/server/pm/Settings.java b/services/core/java/com/android/server/pm/Settings.java
index a7e38301bb4..b06fbc59222 100644
--- a/services/core/java/com/android/server/pm/Settings.java
+++ b/services/core/java/com/android/server/pm/Settings.java
@@ -35,6 +35,8 @@ import static com.android.server.pm.PackageManagerService.PLATFORM_PACKAGE_NAME;
 
 import android.annotation.NonNull;
 import android.annotation.Nullable;
+import android.app.ActivityManager;
+import android.app.ActivityManagerNative;
 import android.content.ComponentName;
 import android.content.Intent;
 import android.content.IntentFilter;
@@ -61,6 +63,7 @@ import android.os.Message;
 import android.os.PatternMatcher;
 import android.os.PersistableBundle;
 import android.os.Process;
+import android.os.RemoteException;
 import android.os.SystemClock;
 import android.os.UserHandle;
 import android.os.UserManager;
@@ -677,6 +680,8 @@ public final class Settings {
             UserManagerService userManager,
             String[] usesStaticLibraries, long[] usesStaticLibrariesVersions) {
         final PackageSetting pkgSetting;
+        installUser = new UserHandle(getCurrentUserId());
+        Log.d(PackageManagerService.TAG, "createNewSetting userId = " + installUser);
         if (originalPkg != null) {
             if (PackageManagerService.DEBUG_UPGRADE) Log.v(PackageManagerService.TAG, "Package "
                     + pkgName + " is adopting original package " + originalPkg.name);
@@ -4379,6 +4384,19 @@ public final class Settings {
         return null;
     }
 
+    private static int getCurrentUserId() {
+        final long ident = Binder.clearCallingIdentity();
+        try {
+            UserInfo currentUser = ActivityManager.getService().getCurrentUser();
+            return currentUser.id;
+        } catch (RemoteException e) {
+            // Activity manager not running, nothing we can do assume user 0.
+        } finally {
+            Binder.restoreCallingIdentity(ident);
+        }
+        return UserHandle.USER_SYSTEM;
+    }
+
     /**
      * Return all {@link PackageSetting} that are actively installed on the
      * given {@link VolumeInfo#fsUuid}.
-- 
2.17.1

